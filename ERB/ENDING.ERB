;オープニング
@OPENING
DRAWLINE
REPEAT 16
	A = COUNT+500
	PRINTFORMSW STR:A
REND

PRINTFORMSL STR:516
PRINTFORMSL STR:517
PRINTFORMSW STR:518
PRINTFORMSW STR:519
PRINTFORMSL STR:520
PRINTFORMSW STR:521
PRINTFORMSW STR:522
PRINTFORMSW STR:523
PRINTFORMSL STR:524
PRINTFORMSL STR:525
PRINTFORMSL STR:526
PRINTFORMS STR:527
A = FLAG:4+527
PRINTFORMS STR:A
PRINTFORMSW STR:531

REPEAT 19
	A = COUNT+532
	PRINTFORMSW STR:A
REND



RETURN 0


;チュートリアル
@TUTORIAL

PRINTFORMSW STR:600
PRINTFORMSL STR:601
PRINTFORMSL STR:602
PRINTFORMSW STR:603
PRINTL 
$INPUT_LOOP
PRINTFORMSL STR:604
PRINTFORMSL STR:605
PRINTFORMSL STR:616
PRINTFORMSL STR:620
PRINTFORMSL STR:626
PRINTFORMSL STR:631
PRINTFORMSL STR:636
PRINTFORMSL STR:639
INPUT
IF RESULT == 9
	PRINTFORMSW STR:640
	RETURN 0
ELSEIF RESULT == 0
	PRINTFORMSL STR:606
	PRINTFORMSW STR:607
	IF FLAG:5 == 9
		PRINTFORMSW STR:641
		PRINTFORMSW STR:642
	ELSE
		PRINTFORMSW STR:608
		PRINTFORMSW STR:609
		PRINTFORMSW STR:610
		PRINTFORMSW STR:611
		PRINTFORMSW STR:612
		PRINTFORMSW STR:613
		PRINTFORMSW STR:614
		PRINTFORMSW STR:615
	ENDIF
	PRINTL 
ELSEIF RESULT == 1
	PRINTFORMSW STR:617
	PRINTFORMSW STR:618
	PRINTFORMSW STR:619
	PRINTL 
ELSEIF RESULT == 2
	PRINTFORMSW STR:621
	PRINTFORMSW STR:622
	PRINTFORMSW STR:623
	PRINTFORMSW STR:624
	PRINTFORMSW STR:625
	PRINTL 
ELSEIF RESULT == 3
	PRINTFORMSW STR:627
	PRINTFORMSW STR:628
	PRINTFORMSW STR:629
	PRINTFORMSW STR:630
	PRINTL 
ELSEIF RESULT == 4
	PRINTFORMSW STR:632
	PRINTFORMSW STR:633
	PRINTFORMSW STR:634
	PRINTFORMSW STR:635
	PRINTL 
ELSEIF RESULT == 5
	PRINTFORMSW STR:637
	PRINTFORMSW STR:638
	PRINTL 
ELSE
	PRINTL 
ENDIF
GOTO INPUT_LOOP


;エンディングチェック
@ENDING_CHECK

PRINTL 納金の手段を選択してください（エンディング内容が変化します）
PRINTL [0] - 直接納める（通常エンド)
A = 0
B = -1
C = -1
D = -1
E:0 = 0
E:1 = 0
F:0 = 0
F:1 = 0
G:0 = 0
G:1 = 0
H:0 = 0
H:1 = 0
I:0 = 0
I:1 = 0
J:0 = 0
J:1 = 0
K:0 = 0
K:1 = 0
L:0 = 0
L:1 = 0
REPEAT CHARANUM
	SIF TALENT:COUNT:3 || TALENT:COUNT:4 || TALENT:COUNT:5 || TALENT:COUNT:6 || TALENT:COUNT:7 || TALENT:COUNT:8
		A += 1
	SIF TALENT:COUNT:6
		B = COUNT
	SIF TALENT:COUNT:7
		C = COUNT
	SIF TALENT:COUNT:8
		D = COUNT
	;特殊ハーレムエンド判定

REND

;恋慕エンド
SIF B >= 0 && FLAG:30 == 1
	PRINTFORML [1] - %CALLNAME:B%への指輪を買う（恋慕エンド）
;淫乱エンド
SIF C >= 0 && FLAG:31 == 1
	PRINTFORML [2] - %CALLNAME:C%へのバイブを買う（淫乱エンド）
;服従エンド
SIF D >= 0 && FLAG:32 == 1
	PRINTFORML [3] - %CALLNAME:D%への首輪を買う（服従エンド）
;ハーレムエンド
SIF (B >= 0 || C >= 0 || D >= 0) && A >= 5
	PRINTFORML [4] - 館の権利書を買う（ハーレムエンド）

;？？？
SIF B >= 0 && C >= 0 && D >= 0 && (FLAG:30+FLAG:31+FLAG:32) >= 5
	PRINTL [99]- ？？？（？？？エンド）
PRINTL [100] やめる

$INPUT_LOOP
INPUT
IF RESULT == 100
	RETURN 0
ELSEIF RESULT == 0
	MONEY -= 1000000
	CALL ENDING_1
ELSEIF RESULT == 1 && B >= 0 && FLAG:30 == 1
	MONEY -= 1000000
	TARGET = B
	CALL ENDING_2
ELSEIF RESULT == 2 && C >= 0 && FLAG:31 == 1
	MONEY -= 1000000
	TARGET = C
	CALL ENDING_3
ELSEIF RESULT == 3 && D >= 0 && FLAG:32 == 1
	MONEY -= 1000000
	TARGET = D
	CALL ENDING_4
ELSEIF RESULT == 4 && (B >= 0 || C >= 0 || D >= 0) && A >= 5
	MONEY -= 1000000
	CALL ENDING_5
ELSEIF RESULT == 99 && B >= 0 && C >= 0 && D >= 0 && (FLAG:30+FLAG:31+FLAG:32) >= 5
	MONEY -= 1000000
	CALL ENDING_0
ELSE
	GOTO INPUT_LOOP
ENDIF

;バッドエンド
@BADENDING_1
DRAWLINE
REPEAT 14
	A = COUNT+1000
	PRINTFORMSW STR:A
REND
QUIT

@BADENDING_2
DRAWLINE
REPEAT 20
	A = COUNT+1020
	PRINTFORMSW STR:A
REND
QUIT

;グッドエンド
;ノーマルエンド
@ENDING_1
DRAWLINE
REPEAT 14
	A = COUNT+1100
	PRINTFORMSW STR:A
REND
CALL GAME_CONTINUE

;恋慕単体エンド
@ENDING_2
SIF CFLAG:21 == 1
	CALL KOJO_MESSAGE_ENDING
SIF FLAG:5 == 9
	RETURN 0

DRAWLINE
REPEAT 13
	A = COUNT+1120
	PRINTFORMSW STR:A
REND
CALL GAME_CONTINUE

;淫乱単体エンド
@ENDING_3
SIF CFLAG:21 == 1
	CALL KOJO_MESSAGE_ENDING
SIF FLAG:5 == 9
	RETURN 0

DRAWLINE
REPEAT 12
	A = COUNT+1140
	PRINTFORMSW STR:A
REND
CALL GAME_CONTINUE

;服従単体エンド
@ENDING_4
SIF CFLAG:21 == 1
	CALL KOJO_MESSAGE_ENDING
SIF FLAG:5 == 9
	RETURN 0

DRAWLINE
REPEAT 12
	A = COUNT+1160
	PRINTFORMSW STR:A
REND
CALL GAME_CONTINUE

;ハーレムエンド
@ENDING_5
REPEAT CHARANUM
	IF CFLAG:COUNT:21 == 2
		TARGET = COUNT
		CALL KOJO_MESSAGE_ENDING
	ENDIF
	SIF FLAG:5 == 9
		BREAK
REND
SIF FLAG:5 == 9
	RETURN 0

DRAWLINE
REPEAT 8
	A = COUNT+1200
	PRINTFORMSW STR:A
REND
;妊娠奴隷
IF ABL:4 >= 5
	B = 1220
;アナル奴隷
ELSEIF ABL:5 >= 5 && TALENT:処女
	B = 1230
;それ以外
ELSE
	B = 1210
ENDIF
REPEAT 6
	A = COUNT+B
	PRINTFORMSW STR:A
REND
PRINTFORMSW STR:1207
PRINTFORMSW STR:1208
CALL GAME_CONTINUE


;？？？エンド
@ENDING_0
DRAWLINE
REPEAT 75
	A = COUNT+2000
	PRINTFORMSW STR:A
REND
$INPUT_LOOP
PRINTFORMSL STR:2075
PRINTFORMSL STR:2076
INPUT
IF RESULT == 0
	REPEAT 28
		A = COUNT+2077
		PRINTFORMSW STR:A
	REND
	QUIT
ELSEIF RESULT == 1
	REPEAT 10
		A = COUNT+2105
		PRINTFORMSW STR:A
	REND
	ABL:MASTER:2 = 10
	ABL:MASTER:10 = 10
	ABL:MASTER:13 = 10
	FLAG:5 = 9
	NOITEM = 1
	MONEY += 10000000
	TALENT:MASTER:52 = 1
	TALENT:MASTER:53 = 1
	TALENT:MASTER:55 = 1
	TALENT:MASTER:64 = 1
	TALENT:MASTER:83 = 1
	TALENT:MASTER:87 = 1
	TALENT:MASTER:94 = 1
	TALENT:MASTER:141 = 1
	TALENT:MASTER:144 = 1
	TALENT:MASTER:145 = 1
	TALENT:MASTER:152 = 1
	RETURN 0
ELSE
	GOTO INPUT_LOOP
ENDIF

@GAME_CONTINUE
PRINTL ゲームを継続しますか？
PRINTC [0]終わる
PRINTC [1]続ける
PRINTL  

$INPUT_LOOP
INPUT

IF RESULT == 0
	QUIT
ELSEIF RESULT == 1
	FLAG:2 += 1
	FLAG:3 += 1
	FLAG:5 = 9
ELSE
	GOTO INPUT_LOOP
ENDIF
RETURN 1


;周回処理
;条件を満たすことで可能
;クリア回数により、引き継げる奴隷の数が増える
@SUCCESSION
IF FLAG:5 == 9
	PRINTFORML {FLAG:2+1}周目を開始しますか？
ELSE
	PRINTFORML {FLAG:2+1}周目をやり直しますか？
ENDIF
PRINTFORML [0] はい
PRINTFORML [1] いいえ
$INPUT_LOOP
INPUT
SIF RESULT < 0 || RESULT > 1
	GOTO INPUT_LOOP
SIF RESULT == 1
	RETURN 0


;引き継ぎフラグ初期化
REPEAT CHARANUM
	CFLAG:COUNT:50 = 0
	CFLAG:COUNT:51 = 0
REND
TARGET = -1
ASSI = -1


;D:引き継ぐキャラの人数
D = 0
REPEAT CHARANUM
	SIF TALENT:COUNT:3 || TALENT:COUNT:4 || TALENT:COUNT:5 || TALENT:COUNT:6 || TALENT:COUNT:7 || TALENT:COUNT:8
		D += 1
REND

SIF D > FLAG:3
	D = FLAG:3

;eratohoAでは、1.引き継ぐキャラを生成→2.次の引き継ぐキャラを選ぶ→3.全部キャラを選んだら引き継がなかったキャラを消す
;という処理をしていたせいで、3周目にバグが発生するようになっていた。

;CFLAG:X:51 引き継ぎ選択したキャラクターかどうか
$SUCCESSION＿LOOP
PRINTFORML 陥落済みの奴隷を、あと{D}人引き継ぐことができます
PRINTFORML 誰を引き継ぎますか？
REPEAT CHARANUM
	SIF COUNT == MASTER
		CONTINUE
	SIF CFLAG:COUNT:51 == 1
		CONTINUE
	SIF (TALENT:COUNT:3 || TALENT:COUNT:4 || TALENT:COUNT:5 || TALENT:COUNT:6 || TALENT:COUNT:7 || TALENT:COUNT:8) == 0
		CONTINUE
	PRINTFORM [{COUNT}] 
	SIF COUNT < 10
		PRINT  
	SIF COUNT < 100
		PRINT  
	PRINTFORML %CALLNAME:COUNT%
REND
PRINTL [10000] 引き継がない
INPUT
IF RESULT == 10000
	D = 0
ELSEIF RESULT < 0 || RESULT > CHARANUM 
	GOTO SUCCESSION＿LOOP
ENDIF

A = RESULT
SIF D > 0
	CFLAG:A:51 = 1
D -= 1
SIF D > 0
	GOTO SUCCESSION＿LOOP


;ここでCFLAG:51 == 1 のキャラクターを生成する
;FORとREPEATが入れ子になってるのでいじるときは注意
;ここ参照　→　http://seesaawiki.jp/eratoho/d/ERB%B9%BD%CA%B8%B9%D6%BA%C22#content_1_3_10
;FORを使っているのでEmueraでないと動作しなくなりました

A = 0
B = 0
S = CHARANUM 
FOR B, 0, S
	IF CFLAG:B:51 == 1
		A = B
		CALL SUCCESSION_CHARA
	ENDIF
NEXT



;キャラ削除部分
C = 0
REPEAT CHARANUM
	SIF CFLAG:C:50 == 1
		C += 1
REND

D = 0
REPEAT S
	SIF COUNT == MASTER
		CONTINUE
	SIF CFLAG:C:50 == 1
		CONTINUE
	D = 1
	DELCHARA D
REND

REPEAT VARSIZE("FLAG")
	SIF COUNT == 1
		CONTINUE
	SIF COUNT == 2 || COUNT == 3
		CONTINUE
	SIF COUNT == 6 || COUNT == 7
		CONTINUE
	SIF COUNT == 99
		CONTINUE
	FLAG:COUNT = 0
REND

REPEAT VARSIZE("ITEM")
	ITEM:COUNT = 0
REND

REPEAT VARSIZE("PBAND")
	PBAND:COUNT = 0
REND

TARGET = -1
ASSI = -1

REPEAT 99
	ITEMSALES:COUNT = 1
REND

CALL CHARA_PRICE

PBAND = 12
FLAG:6 = 1
FLAG:99 = 8
DAY = 1
MONEY = 20000

;難易度選択
PRINTL ★★難易度を選択してください★★
PRINTL [0]EASY
PRINTL [1]NORMAL
PRINTL [2]HARD

$INPUT_LOOP_2
INPUT
IF RESULT >= 0 && RESULT <= 2
	FLAG:4 = RESULT+1
ELSE
	GOTO INPUT_LOOP_2
ENDIF
RETURN 0



@SUCCESSION_CHARA
C = NO:A
ADDCHARA C
TARGET = CHARANUM -1
REPEAT VARSIZE("ABL")
	ABL:COUNT = ABL:A:COUNT
REND
REPEAT VARSIZE("EXP")
	EXP:COUNT = EXP:A:COUNT
REND
REPEAT VARSIZE("MARK")
	MARK:COUNT = MARK:A:COUNT
REND
REPEAT VARSIZE("RELATION")
	RELATION:COUNT = RELATION:A:COUNT
REND
REPEAT VARSIZE("JUEL")
	JUEL:COUNT = JUEL:A:COUNT
REND
REPEAT VARSIZE("CFLAG")
	CFLAG:COUNT = CFLAG:A:COUNT
REND
REPEAT VARSIZE("TALENT")
	TALENT:COUNT = TALENT:A:COUNT
REND
CFLAG:50 = 1



